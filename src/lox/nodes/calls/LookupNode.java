package lox.nodes.calls;

import com.oracle.truffle.api.frame.VirtualFrame;
import com.oracle.truffle.api.nodes.ExecutableNode;
import lox.LoxContext;
import lox.nodes.ExpressionNode;
import lox.nodes.functions.FunctionRootNode;
import lox.objects.LoxClassObject;

public class LookupNode extends ExpressionNode {
    private final ExpressionNode lookupExpr;

    public LookupNode(ExpressionNode lookupExpr) {
        this.lookupExpr = lookupExpr;
    }

    @Override
    public Object executeGeneric(VirtualFrame frame) {
        LoxContext context = LoxContext.get(this);
        Object caller = this.lookupExpr.executeGeneric(frame);

        if (caller instanceof ExecutableNode) // or just RootNode? or just FunctionRootNode? No idea
            return caller;

        if (!(caller instanceof String callerString))
            throw new RuntimeException("Attempting to call something from something other than an identifier");

        Object lookup = lookupFunction(callerString, context);
        if (lookup != null)
            return lookup;

        lookup = lookupClass(callerString, context);
        if (lookup != null)
            return lookup;


        throw new RuntimeException("Couldn't look up the caller " + callerString + " (neither a known function nor class)");
    }

    private FunctionRootNode lookupFunction(String callerString, LoxContext context) {
        return context.globalScope.getFunction(callerString); // TODO those two should be specializations executeFunction() and executeClass(), context probably cached?
    }

    private LoxClassObject lookupClass(String callerString, LoxContext context) {
        return context.globalScope.getClass(callerString);
    }
}
